\documentclass[10pt, a4paper, twoside]{basestyle}
\usepackage{tkz-euclide}
\usetkzobj{all}
\usepackage[Mathematics]{semtex}

%%%% Shorthands.

%%%% Title and authors.

\newcommand{\point}[1]{\mathrm{#1}}
\newcommand{\bipoint}[2]{\overrightarrow{\point #1 \point #2}}
\newcommand{\straightline}[2]{\point #1 \point #2}
\newcommand{\plane}[3]{\point #1 \point #2 \point #3}
\newcommand{\squarenorm}[1]{\scal{#1}{#1}}

\title{%
\textdisplay{%
Hiding Computations in Projection%
}%
}
\author{Pascal~Leroy (pleroy)}
\begin{document}
\maketitle
Notation: $\point A$ and $\point B$ are the extremities of the segment;
$\point C$ is the centre of the sphere; $R$ is the radius of the sphere;
$\point K$ is the location of the camera.

We start our analysis by eliminating a case that would cause anomalies in the
computations below.  If\[
\scal{\bipoint KC}{\bipoint KC} < R^2
\]
then the camera is inside the sphere and the segment is hidden irrespective of
its position.

Next, consider the plane that contains $\point K$ and is orthogonal to
$\bipoint KC$; it separates the entire space into two half-spaces.  If the
segment $\bipoint AB$ is entirely within the half-space that does not contain
$\point C$ then the segment is not hidden.  This is the case if the following
inequalities are both true
\begin{align*}
\scal{\bipoint KA}{\bipoint KC} &< 0\\
\scal{\bipoint KB}{\bipoint KC} &< 0\text.
\end{align*}

For simplicity we will do the rest of our analysis in the plane $\plane KAB$.
We will use $\tuple{\bipoint KA, \bipoint KB}$ as a basis of that plane.
Let $\point H$ be the orthogonal projection of $\point C$ on $\plane KAB$.
Define $\ga$, $\gb$ to be its coordinates in $\plane KAB$\[
\bipoint KH = \ga \bipoint KA + \gb \bipoint KB\text.
\]
Note that $\bipoint KH = \bipoint KC + \bipoint CH$. By its definition,
$\bipoint CH$ is orthogonal to both $\bipoint KA$ and $\bipoint KB$
\begin{align*}
\scal{\bipoint KA}{\bipoint CH} &= 0\\
\scal{\bipoint KB}{\bipoint CH} &= 0\text,
\end{align*}
or
\begin{align*}
\scal{\bipoint KA}{\bipoint KH} &= \scal{\bipoint KA}{\bipoint KC}\\
\scal{\bipoint KB}{\bipoint KH} &= \scal{\bipoint KB}{\bipoint KC}\text.
\end{align*}
Expanding $\bipoint KH$ gives a linear system of two equations with two unknowns
\begin{align*}
\ga \scal{\bipoint KA}{\bipoint KA} + \gb \scal{\bipoint KA}{\bipoint KB}
    &= \scal{\bipoint KA}{\bipoint KC}\\
\ga \scal{\bipoint KA}{\bipoint KB} + \ga \scal{\bipoint KB}{\bipoint KB}
    &= \scal{\bipoint KB}{\bipoint KC}\text.
\end{align*}
The determinant of this system is\[
D = \pascal{\squarenorm{\bipoint KA}} \pascal{\squarenorm{\bipoint KB}}
    - \pascal{\scal{\bipoint KA}{\bipoint KB}}^2\text,
\]
which is non-zero if and only if $\point A \neq \point B$. The solutions are
thus
\begin{align*}
\ga &= \frac
  {\pascal{\squarenorm{\bipoint KB}} \pascal{\scal{\bipoint KA}{\bipoint KC}} -
   \pascal{\scal{\bipoint KA}{\bipoint KB}}
   \pascal{\scal{\bipoint KB}{\bipoint KC}}}
  {D}\\
\gb &= \frac
  {\pascal{\squarenorm{\bipoint KA}} \pascal{\scal{\bipoint KB}{\bipoint KC}} -
   \pascal{\scal{\bipoint KA}{\bipoint KB}}
   \pascal{\scal{\bipoint KA}{\bipoint KC}}}
  {D}\text.
\end{align*}
Now that $\bipoint KH$ is determined we can compute
$\bipoint CH = \bipoint KH - \bipoint KC$.  If
$\squarenorm{\bipoint CH} \geq R^2$, the sphere is either tangent to
the plane $\plane KAB$ or doesn't intersect it. Thus, there is no hiding.

Let's look at a figure in the plane $\plane KAB$ when the sphere intersects
that plane.  Let $r$ be the radius of the intersection circle; it is such that
$r^2 = R^2 - \squarenorm{\bipoint CH}$.

If the circle doesn't intersect the wedge $\plane KAB$ then the segment
$\straightline AB$ is entirely visible.  To find if this is the case, first
observe that, if $\gq$ is the angle between $\bipoint KA$ and $\bipoint KB$, we
have
\[
\scal{\bipoint KA}{\bipoint KB} = \norm {\bipoint KA} \norm {\bipoint KB}
                                  \cos \gq
\]
\marginfig[Circle outside of the wedge $\plane KAB$.\label{figOutside}]{
\begin{tikzpicture}[scale=0.5]
\tkzInit[ymin=-7,ymax=8,xmin=-1,xmax=9]\tkzClip
\tkzDefPoint(3,5){A}
\tkzDefPoint(8,0){B}
\tkzDefPoint(4,-3){H}
\tkzDefPoint(0,0){K}

\tkzDefLine[orthogonal=through H](K,B) \tkzGetPoint{h1}
\tkzInterLL(H,h1)(K,B) \tkzGetPoint{N}

\tkzDefLine[parallel=through H](K,A) \tkzGetPoint{h2}
\tkzInterLL(H,h2)(K,B) \tkzGetPoint{M}

\tkzDefPointWith[linear,K=2](H,M) \tkzGetPoint{m}

\tkzDrawPoints(A,B,H,K,M,N)
\tkzLabelPoint[left](A){$\point A$}
\tkzLabelPoint[above](B){$\point B$}
\tkzLabelPoint[left](H){$\point H$}
\tkzLabelPoint[above left](K){$\point K$}
\tkzLabelPoint[below right](M){$\point M$}
\tkzLabelPoint[above left](N){$\point N$}

\tkzDrawLine(K,A)
\tkzDrawLine(K,B)
\tkzDrawLine(H,N)
\tkzDrawLine[add=0.2 and 0.5](H,M)

\tkzDrawCircle[R](H,3cm)

\tkzMarkRightAngle[size=0.5](H,N,M)
\tkzMarkAngle[size=0.5](B,K,A)
\tkzLabelAngle(A,K,B){$\gq$}
\tkzMarkAngle[size=0.5](B,M,m)
\tkzLabelAngle(B,M,m){$\gq$}

\end{tikzpicture}
}
Assume that $\point H$ is outside the wedge $\plane KAB$ and in a position where
the circle is tangent to $\straightline KB$ at point $\point N$.  Let $\point M$
be the point where $\point H$ projects on $\bipoint KB$ parallel to
$\bipoint KA$.  We have
\[
{\bipoint HM} = \ga {\bipoint KA}
\]
and
\[
\scal{\bipoint HM}{\bipoint HM} = \frac{r^2} {\sin^2 \gq} =
                                  \frac{r^2} {1 - \cos^2 \gq}
\]
Eliminating $\bipoint HM$ we obtain the following conditions on $\ga$ for
$\point H$ to be in the position indicated above
\begin{align*}
\ga &< 0\\
\ga^2 &> r^2 \frac{\scal{\bipoint KB}{\bipoint KB}}
                  {(\scal{\bipoint KA}{\bipoint KA})
                   (\scal{\bipoint KB}{\bipoint KB}) -
                  {(\scal{\bipoint KA}{\bipoint KB}})^2}\text.
\end{align*}
We have similar conditions on $\gb$ for the circle to be outside the wedge
$\plane KAB$ and tangent to $\bipoint KA$.

The next step is to find out the extension of the wedge formed by the circle
when seen from $\point K$.  Let $\point P$ be a point where a line
going through $K$ is tangent to the circle, and let $\point Q$ be the point 
where $\straightline KP$ intersects $\straightline AB$; it may be between
$\point K$ and $\point P$ or behind $\point P$.

We need to find $\point P$. It is defined by two equations
\begin{align*}
\squarenorm{\bipoint PH} &= r^2\\
\scal{\bipoint PH}{\bipoint KP} &= 0\text.
\end{align*}
The second equation may be rewritten
\[
\scal{\bipoint PH}{\pascal{\bipoint KH + \bipoint HP}} = 0
\]
from which we obtain
\[
\scal{\bipoint PH}{\bipoint KH} = r^2\text.
\]
Let $\gg$ and $\gd$ be the coordinates of $\bipoint PH$ in $\plane KAB$\[
\bipoint PH = \gg {\bipoint KA} + \gd {\bipoint KB}\text.
\]
The second equation is linear\[
\gg\scal{\bipoint KA}{\bipoint KH} + \gd\scal{\bipoint KB}{\bipoint KH} =
r^2\text,
\]
thus\[
\gg = \frac{r^2 - \gd \scal{\bipoint KB}{\bipoint KH}}
           {\scal{\bipoint KA}{\bipoint KH}}\text.
\]
Note that $\scal{\bipoint KA}{\bipoint KH}$ and
$\scal{\bipoint KB}{\bipoint KH}$ cannot both be $0$ unless $\point K$ is on
$\straightline AB$.  The first equation is quadratic\[
\pa{\gg\bipoint KA + \gd \bipoint KB}^2 = r^2\text.
\]
Pluging the value of $\gg$ above we get
\begin{align*}
\gd^2\pa{
 \pascal{\squarenorm{\bipoint KB}} \pascal{\scal{\bipoint KA}{\bipoint KH}}^2 +
 2\pascal{\scal{\bipoint KA}{\bipoint KB}}
  \pascal{\scal{\bipoint KA}{\bipoint KH}}
  \pascal{\scal{\bipoint KB}{\bipoint KH}} +
 \squarenorm{\bipoint KA} \pascal{\scal{\bipoint KB}{\bipoint KH}}^2} &+\\
2\gd r^2\pa{
 \pascal{\scal{\bipoint KA}{\bipoint KB}}
 \pascal{\scal{\bipoint KA}{\bipoint KH}} -
 \pascal{\squarenorm{\bipoint KA}}
 \pascal{\scal{\bipoint KB}{\bipoint KH}}} &+\\
r^2\pa{
 r^2\pascal{\squarenorm{\bipoint KA}} -
 \pascal{\scal{\bipoint KA}{\bipoint KH}}^2} &= 0\text.
\end{align*}
This equation always has two solutions because the sphere intersects
$\plane KAB$.  Having determined $\bipoint PH$, we can find $\point Q$.
$\point Q$ is on the line $\straightline AB$, thus\[
\bipoint AQ = \gl \bipoint AB\text,
\] which can be written \[
\bipoint KQ - \bipoint KA = \gl \bipoint AB\text.
\]
Noting that $\bipoint KQ$ is orthogonal to $\bipoint PH$ we have\[
-\scal{\bipoint KA}{\bipoint PH} = \gl \scal{\bipoint AB}{\bipoint PH}
\text{, or, }
\gl = -\frac{\scal{\bipoint KA}{\bipoint PH}}{\scal{\bipoint AB}{\bipoint PH}}
\text.
\]

\marginfig[Definition of $\point S$ and $\point T$.\label{figST}]{
\begin{tikzpicture}[scale=0.5]
\tkzInit[ymin=-5,ymax=12,xmin=-4,xmax=6]\tkzClip
\tkzDefPoint(2,11){A}
\tkzDefPoint(5,-4){B}
\tkzDefPoint(0,0){H}
\tkzDefPoint(0,6){K}

\tkzTangent[from with R=K](H,3cm) \tkzGetPoints{P2}{P}

\tkzDefLine[orthogonal=through P](K,H) \tkzGetPoint{p}
\tkzInterLL(P,p)(A,B) \tkzGetPoint{T}
\tkzInterLL(P,p)(K,H) \tkzGetPoint{q}

\tkzDefLine[orthogonal=through K](K,H) \tkzGetPoint{k}
\tkzInterLL(K,k)(A,B) \tkzGetPoint{S}

\tkzDrawPoints(A,B,H,K,P,S,T)
\tkzLabelPoint[left](A){$\point A$}
\tkzLabelPoint[left](B){$\point B$}
\tkzLabelPoint[left](H){$\point H$}
\tkzLabelPoint[left](K){$\point K$}
\tkzLabelPoint[below left](P){$\point P$}
\tkzLabelPoint[above right](S){$\point S$}
\tkzLabelPoint[above right](T){$\point T$}

\tkzDrawLine[add=0.2 and 3](A,B)
\tkzDrawLine(H,K)
\tkzDrawLine[add=1 and 1](K,P)
\tkzDrawLine[add=1 and 1](K,P2)
\tkzDrawLine[add=0.05 and 0.2](K,S)
\tkzDrawLine[add=2.2 and 0.2](P,T)

\tkzDrawCircle[R](H,3cm)

\tkzMarkRightAngle[size=0.5](S,K,H)
\tkzMarkRightAngle[size=0.5](P,q,H)

\end{tikzpicture}
}
Having determined the values of $\gl$ we need to find out where $\point Q$ is
located with respect to the segment $\bipoint AB$.  Let $\point S$ be the
intersection of $\straightline AB$ with the line orthogonal to
$\straightline KH$ at $\point K$.  We locate $\point S$ on $\straightline AB$ as
follows\[
\bipoint KS = \bipoint KA + \gs \bipoint AB\text.
\]
Noting that $\scal{\bipoint KS}{\bipoint KH} = 0$ we obtain\[
\gs = -\frac{\scal{\bipoint KA}{\bipoint KH}}
            {\scal{\bipoint AB}{\bipoint KH}}
\]
Now let $\point T$ be the intersection of $\straightline AB$ with the line
orthogonal to $\straightline KH$ at $\point P$.  We locate $\point T$ on
$\straightline AB$ similarly\[
\bipoint KT = \bipoint KA + \gt \bipoint AB\text.
\]
We have\[
\bipoint PT = \bipoint KA + \gt \bipoint AB - \bipoint KH + \bipoint PH
\]
Noting that $\scal{\bipoint PT}{\bipoint KH} = 0$ we obtain\[
\gt = \frac{\scal{\bipoint KH}{\bipoint KH} - \scal{\bipoint PH}{\bipoint KH} -
            \scal{\bipoint KA}{\bipoint KH}}
           {\scal{\bipoint AB}{\bipoint KH}}
\]
We can now determine if $\gl$ is an ``interesting'' intersection, i.e., one that
intersects the cone behind the sphere when seen from the camera.  First, assume
that $\point A$ and $\point B$ are in the same order as $\point S$ and
$\point T$ on $\straightline AB$.  Then we have $\gs \leq \gt$ and the
intersection is farther than $\point T$ (as seen from the camera) if and only if
$\gt < \gl$.  Conversely, if $\point A$ and $\point B$ are in the reverse order
as $\point S$ and $\point T$ on $\straightline AB$ we have $\gt \leq \gs$ and
the intersection is farther than $\point T$ if and only if $\gl < \gt$

There is another special case to handle: if the line $\straightline AB$ is in
"hyperbolic" position, i.e. intersects both halves of the cone, then one value
of $\gl$ is smaller than $\gs$ and one value is greater than $\gs$.  Exactly one
of the values of $\gl$ will be retained by the preceding analysis, and we need
to add an extra $\gl$ equal to an infinity with the sign of $\gt - \gs$ to
account for the fact that all the points farther than $\point T$ are hidden
by the cone.

To complete the analysis we need to compute the intersection $\point Q$ of the
sphere (not the cone) with the line $\straightline AB$. $\point Q$ is on the
sphere, thus
\[
\squarenorm{\bipoint CQ} = R^2\text.
\]
It is also on the line $\straightline AB$ thus\[
\bipoint KQ = \bipoint KA + \gm \bipoint AB\text.
\]
We have\[
\bipoint CQ = \bipoint KQ - \bipoint KC =
  \bipoint KA + \gm \bipoint AB - \bipoint KC =
  \bipoint CA + \gm \bipoint AB\text,
\]
and therefore\[
R^2 = \pascal{\bipoint CA + \gm \bipoint AB}^2\text,
\]
meaning that $\gm$ is a solution of\[
\gm \squarenorm{\bipoint AB} + 2 \gm \scal{\bipoint CA}{\bipoint AB}
+ \squarenorm{\bipoint CA} - R^2 = 0\text.
\]
Depending on the location of the segment with respect to the sphere, there can
be $0$, $1$, or $2$ intersections.

If we take the union of the values of $\gl$ and $\gm$ and order them, it is
straightforward to find the visible segments. Remember that $0<\gl,\gm<1$ for
points that are in the segment $\straightline AB$.
\end{document}
