syntax = "proto2";

import "serialization/geometry.proto";
import "serialization/physics.proto";
import "serialization/quantities.proto";

package principia.serialization;

message HistoryAndProlongation {
  required Trajectory history = 1;
  required Trajectory.Iterator prolongation = 2;
}

message Vessel {
  required MasslessBody body = 1;
  oneof trajectory_bundle {
    HistoryAndProlongation history_and_prolongation = 2;
    Trajectory owned_prolongation = 3;
  }
}

message Celestial {
  required MassiveBody body = 1;
  required HistoryAndProlongation history_and_prolongation = 2;
}

message Part {
  required Pair degrees_of_freedom = 1;
  required Quantity mass = 2;
  required Multivector gravitational_acceleration_to_be_applied_by_ksp = 3;
}

message PhysicsBubble {
  message FullState {
    message PartIdToPart {
      required fixed32 part_id = 1;
      required Part part = 2;
    }
    message VesselPointerToDegreesOfFreedom {
      required Plugin.VesselPointer vessel = 1;
      required Pair degrees_of_freedom = 2;
    }
    repeated Plugin.VesselPointer vessels = 1;
    repeated PartIdToPart parts = 2;
    required Pair centre_of_mass = 3;
    required Trajectory centre_of_mass_trajectory = 4;
    repeated VesselPointerToDegreesOfFreedom from_centre_of_mass = 5;
    required Pair correction = 6;
  }
  required MasslessBody body = 1;
  optional FullState current = 2;
}

message Plugin {
  // NOTE(egg): Assuming 32-bit. If we have 2^32 vessels we'll probably
  // encounter other issues on the way.
  message VesselPointer {
    required uint32 distance_from_vessels_begin = 1;
  }
  message CelestialPointer {
    required uint32 distance_from_celestials_begin = 1;
  }
  message VesselPointerToParent {
    required VesselPointer vessel = 1;
    required CelestialPointer parent = 2;
  }
  message CelestialPointerToParent {
    required CelestialPointer celestial = 1;
    optional CelestialPointer parent = 2;
  }
  message GuidToVessel {
    required string guid = 1;
    required Vessel vessel = 2;
  }
  message IndexToCelestial {
    required int32 index = 1;
    required Celestial celestial = 2;
  }
  repeated GuidToVessel vessels = 1;
  repeated IndexToCelestial celestials = 2;
  repeated VesselPointerToParent vessel_parents = 3;
  repeated CelestialPointerToParent celestial_parents = 4;
  repeated VesselPointer dirty_vessels = 5;
  required PhysicsBubble bubble = 6;
  required Quantity planetarium_rotation = 7;
  required Point current_time = 8;
  required CelestialPointer sun = 9;
}
